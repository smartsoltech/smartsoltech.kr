<!-- web/templates/web/modal_order_form.html -->
<div id="orderModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Оформление заявки на услугу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm" method="post" action="{% url 'create_service_request' service_id=service.pk %}">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label">Имя</label>
                        <input id="client_name" class="form-control" type="text" name="client_name" required minlength="2" maxlength="50" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Телефон</label>
                        <input id="client_phone" class="form-control" type="tel" name="client_phone" required pattern="^\+?[0-9\s\-]{7,15}$" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Адрес электронной почты</label>
                        <input id="client_email" class="form-control" type="email" name="client_email" required />
                    </div>
                    <div class="form-group mb-3 text-center">
                        <label class="form-label">Сканируйте QR код для регистрации в Telegram боте</label>
                        <div id="qrCodeContainer">
                            <img id="qrCodeImage" src="{{ qr_code_url }}" alt="QR код для Telegram бота" class="img-fluid" style="max-width: 150px;" />
                        </div>
                        <div class="form-group mt-3">
                            <a id="registrationLink" href="#" target="_blank">Перейдите по этой ссылке для регистрации в Telegram боте</a>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="submit" class="btn btn-primary" id="submitButton" disabled>Отправить заявку</button>
                    </div>
                </form>
                {% comment %} <div id="diagnostic_info" class="mt-3">
                    <form id="registrationForm">
                        <h3>Диагностическая информация</h3>
                        <div class="form-group mb-3">
                            <label for="registrationLinkField" class="form-label">Ссылка для регистрации в Telegram боте:</label>
                            <input type="text" id="registrationLinkField" class="form-control" readonly />
                        </div>
                        <div class="form-group mb-3">
                            <label for="requestIdField" class="form-label">Номер заявки:</label>
                            <input type="text" id="requestIdField" class="form-control" readonly />
                        </div>
                    </form>
                </div> {% endcomment %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submitButton');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const registrationLink = document.getElementById('registrationLink');
        let serviceId = "{{ service.pk }}";  // Получаем значение serviceId из шаблона

        // Генерация QR-кода при открытии формы
        fetch(`/service/generate_qr_code/${serviceId}/`)
            .then(response => response.json())
            .then(data => {
                qrCodeImage.src = data.qr_code_url;
                registrationLink.href = data.registration_link;

                // Извлекаем номер заявки из ссылки на регистрацию
                const requestMatch = data.registration_link.match(/request_(\d+)_token/);
                if (requestMatch) {
                    serviceId = requestMatch[1];
                }

                // Отображение диагностической информации на форме
                //document.getElementById('registrationLinkField').value = data.registration_link;
                //document.getElementById('requestIdField').value = serviceId; 

                // Запуск проверки статуса каждые 5 секунд
                const interval = setInterval(() => {
                    checkVerificationStatus(serviceId, interval);
                }, 5000);
            })
            .catch(error => console.error('Ошибка при генерации QR-кода:', error));

        const checkVerificationStatus = (serviceId, interval) => {
            fetch(`/service/request_status/${serviceId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.is_verified) {
                        // Заполнение полей формы данными пользователя
                        document.getElementById('client_name').value = data.client_name;
                        document.getElementById('client_email').value = data.client_email;
                        document.getElementById('client_phone').value = data.client_phone;

                        // Активируем кнопку отправки, если поля заполнены
                        updateButtonState();

                        // Останавливаем интервал проверки статуса
                        clearInterval(interval);
                    }
                })
                .catch(error => console.error('Ошибка при проверке статуса:', error));
        };

        // Обработчик кнопки отправки формы
        submitButton.addEventListener('click', function () {
            if (submitButton.disabled) {
                return;
            }

            // Проверка наличия данных в таблице ServiceRequest перед отправкой формы
            fetch(`/service/check_service_request_data/?request_id=${serviceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // Обратная связь пользователю
                        alert('Заявка уже существует. Данные будут обновлены.');

                        // Заполнение формы данными из заявки
                        document.getElementById('client_name').value = data.client_name;
                        document.getElementById('client_email').value = data.client_email;
                        document.getElementById('client_phone').value = data.client_phone;

                        // Отправка формы
                        form.submit();
                    } else {
                        // Если данных нет, отправляем форму как новую заявку
                        form.submit();
                    }
                })
                .catch(error => {
                    console.error('Ошибка при проверке данных заявки:', error);
                    alert('Произошла ошибка при проверке данных. Пожалуйста, попробуйте еще раз.');
                });
        });

        // Код для активации кнопки "Отправить" при заполнении полей телефона и email
        const clientEmail = document.getElementById('client_email');
        const clientPhone = document.getElementById('client_phone');

        const updateButtonState = () => {
            if (clientEmail.value && clientPhone.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        };

        // Привязка событий к полям email и телефона
        clientEmail.addEventListener('input', updateButtonState);
        clientPhone.addEventListener('input', updateButtonState);
    });
</script>
